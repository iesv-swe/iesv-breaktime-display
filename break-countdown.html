<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Break Countdown â€“ IESV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-normal: linear-gradient(135deg,#071729,#0d2742);
  --bg-upcoming: linear-gradient(135deg,#004d40,#00796b);
  --bg-inbreak: linear-gradient(135deg,#1b5e20,#43a047);
  --bg-none: linear-gradient(135deg,#311b92,#512da8);

  --text-main: #ffffff;
  --text-muted: #cfd8dc;

  --bar-bg: rgba(255,255,255,0.15);
  --bar-a: #4dd0e1;
  --bar-b: #ffca28;
}

body {
  font-family: system-ui, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-normal);
  color: var(--text-main);
  transition: background 0.5s ease;
  overflow: hidden;
}

body.state-upcoming { background: var(--bg-upcoming); }
body.state-inbreak { background: var(--bg-inbreak); }
body.state-none { background: var(--bg-none); }
body.state-warning { animation: flash-bg 1s ease-in-out infinite alternate; }

@keyframes flash-bg {
  0% { filter: brightness(1); }
  100% { filter: brightness(1.35); }
}

/* ---------- TOP CONTROLS ---------- */
.top-controls {
  width: 100%;
  max-width: 900px;
  padding: 10px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

select, button {
  background: rgba(0,0,0,0.5);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
}
button:hover { background: rgba(255,255,255,0.15); }

.icon-btn {
  font-size: 1.35rem;
  padding: 2px 8px;
}

/* ---------- TIMER ---------- */
.timer-container {
  flex: 1;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}
#timerDisplay {
  font-weight: 700;
  font-size: 18vw;
  font-variant-numeric: tabular-nums;
  text-shadow: 0 0 30px rgba(0,0,0,0.6);
}

/* ---------- COMBINED VIEW ---------- */
.combined-section {
  width: 100%;
  max-width: 900px;
  text-align: center;
  margin-bottom: 10px;
}
.combined-text { font-size:1rem; margin-bottom:14px; }

.bar-row { margin: 12px 0; }
.label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; }

.bar {
  width: 100%;
  height: 40px;
  background: var(--bar-bg);
  border-radius: 10px;
  overflow: hidden;
}
.fillA { height:100%; background: var(--bar-a); width:0%; transition:0.3s; }
.fillB { height:100%; background: var(--bar-b); width:0%; transition:0.3s; }

/* ---------- DEBUG PANEL ---------- */
#debugPanel {
  display:none;
  width:95%;
  max-width:900px;
  margin-bottom:10px;
}
#debugPanel.visible { display:block; }
textarea {
  width:100%;
  height:200px;
  background:rgba(0,0,0,0.6);
  color:#e0f7fa;
  border-radius:10px;
  padding:10px;
  font-family:monospace;
}
</style>
</head>

<body>

<!-- ðŸ”” SCHOOL BELL -->
<audio id="bell" src="school_bell.mp3" preload="auto"></audio>

<!-- ---------- TOP CONTROLS ---------- -->
<div class="top-controls">
  <select id="yearSelect">
    <option value="6" selected>Year 6 (6A & 6B)</option>
    <option value="6A">6A only</option>
    <option value="6B">6B only</option>
  </select>
  <button id="refreshButton">Reload</button>
  <button id="debugToggle">Debug</button>
  <button class="icon-btn" id="testBell">ðŸ””</button>
</div>

<!-- ---------- TIMER / CLOCK ---------- -->
<div class="timer-container">
  <div id="timerDisplay">--:--</div>
</div>

<!-- ---------- COMBINED SECTION ---------- -->
<div id="combinedSection" class="combined-section" style="display:none;">
  <div id="combinedText" class="combined-text"></div>

  <div class="bar-row">
    <div class="label">6A</div>
    <div class="bar"><div id="barA" class="fillA"></div></div>
  </div>

  <div class="bar-row">
    <div class="label">6B</div>
    <div class="bar"><div id="barB" class="fillB"></div></div>
  </div>
</div>

<!-- ---------- DEBUG PANEL ---------- -->
<div id="debugPanel">
  <textarea id="debugJson"></textarea>
  <button id="downloadJson">Download JSON</button>
</div>

<script src="parser.js"></script>
<script>
const bell = document.getElementById("bell");
const yearSelect = document.getElementById("yearSelect");
const timerDisplay = document.getElementById("timerDisplay");
const combinedSection = document.getElementById("combinedSection");
const combinedText = document.getElementById("combinedText");
const barA = document.getElementById("barA");
const barB = document.getElementById("barB");
const testBtn = document.getElementById("testBell");
const debugToggle = document.getElementById("debugToggle");
const debugPanel = document.getElementById("debugPanel");
const debugJson = document.getElementById("debugJson");

let schedule6A = null;
let schedule6B = null;

const SCHOOL_OPEN = 7 * 3600;
const SCHOOL_CLOSE = 17.5 * 3600;


// --------------------------------------------------
// HELPERS
// --------------------------------------------------
function fmtClock(d){
  return String(d.getHours()).padStart(2,"0") + ":" +
         String(d.getMinutes()).padStart(2,"0");
}
function fmtCountdown(sec){
  if(sec < 0) sec = 0;
  const m = Math.floor(sec/60), s = sec%60;
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

// --------------------------------------------------
// BELL
// --------------------------------------------------
function ringBell(type){
  if(type === "lunch") return;   // ðŸš« DO NOT ring after lunch
  bell.currentTime = 0;
  const p = bell.play();
  if(p && p.then){
    p.then(() => setTimeout(()=>bell.pause(),5000))
      .catch(err => console.warn("Bell blocked:",err));
  }
}
testBtn.onclick = ()=> ringBell("passing");


// --------------------------------------------------
// LOAD BREAKS
// --------------------------------------------------
async function loadSchedules(){
  schedule6A = await getScheduleForYear("6A");
  schedule6B = await getScheduleForYear("6B");

  debugJson.value = JSON.stringify({schedule6A,schedule6B},null,2);
}


// --------------------------------------------------
// GET BREAK STATE
// --------------------------------------------------
function getBreakState(schedule, nowSec, day){
  const arr = schedule?.breaksByDay?.[day] || [];
  let active=null, next=null;

  for(const b of arr){
    const s=b.startMinutes*60, e=b.endMinutes*60;
    if(nowSec>=s && nowSec<e) active={...b,startSec:s,endSec:e};
    else if(nowSec<s && !next) next={...b,startSec:s,endSec:e};
  }
  return {active,next};
}


// --------------------------------------------------
// COMBINED PROGRESS
// --------------------------------------------------
function barFill(nextBreak, nowSec){
  if(!nextBreak) return "0%";
  const until = nextBreak.startSec - nowSec;
  if(until <=0) return "100%";
  const ratio = Math.max(0, Math.min(1, 1 - until/5400)); // 90 min window
  return (ratio*100)+"%";
}


// --------------------------------------------------
// MAIN UPDATE LOOP
// --------------------------------------------------
let lastEndA=null, lastEndB=null;

function updateDisplay(){
  const now = new Date();
  const nowSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
  const day = ["Sun","Mon","Tue","Wed","Thur","Fri","Sat"][now.getDay()];

  if(nowSec < SCHOOL_OPEN || nowSec > SCHOOL_CLOSE){
    timerDisplay.textContent = fmtClock(now);
    combinedSection.style.display="none";
    document.body.className="state-none";
    return;
  }

  const stA = getBreakState(schedule6A,nowSec,day);
  const stB = getBreakState(schedule6B,nowSec,day);

  const mode = yearSelect.value;

  // ----------------- SINGLE CLASS MODES -----------------
  const single = mode==="6A" ? stA : (mode==="6B" ? stB : null);
  if(single){
    combinedSection.style.display="none";

    if(single.active){
      const left = single.active.endSec-nowSec;
      timerDisplay.textContent = fmtCountdown(left);
      const type = single.active.type==="lunch" ? "Lunch ends in: " : "Break ends in: ";
      document.body.className = left<=60 ? "state-inbreak state-warning" : "state-inbreak";

      const endTime = single.active.endSec;
      const last = mode==="6A"? lastEndA : lastEndB;
      if(!last) { mode==="6A"? lastEndA=endTime : lastEndB=endTime; }
      if(last===nowSec){
        ringBell(single.active.type);
        mode==="6A"? lastEndA=null : lastEndB=null;
      }
      return;
    }

    if(single.next){
      const until = single.next.startSec-nowSec;
      if(until>5400){
        timerDisplay.textContent=fmtClock(now);
        document.body.className="state-none";
        return;
      }
      timerDisplay.textContent=fmtCountdown(until);
      const kind = single.next.type==="lunch" ? "Lunch starts in: " : "Break starts in: ";
      document.body.className = until<=60 ? "state-upcoming state-warning":"state-upcoming";
      return;
    }

    timerDisplay.textContent=fmtClock(now);
    document.body.className="state-none";
    return;
  }

  // ----------------- YEAR 6 COMBINED -----------------
  combinedSection.style.display="block";

  // ACTIVE BREAK?
  if(stA.active || stB.active){
    combinedSection.style.display="none";

    let chosen = stA.active;
    let owner = "6A";

    if(stB.active && (!stA.active || stB.active.endSec < stA.active.endSec)){
      chosen = stB.active;
      owner = "6B";
    }

    const left = chosen.endSec-nowSec;
    timerDisplay.textContent = fmtCountdown(left);
    const label = chosen.type==="lunch" ? "Lunch ends in: " : "Break ends in: ";

    document.body.className = left<=60? "state-inbreak state-warning":"state-inbreak";

    const endT = chosen.endSec;
    if(owner==="6A"){
      if(!lastEndA) lastEndA=endT;
      if(lastEndA===nowSec){ ringBell(chosen.type); lastEndA=null; }
    } else {
      if(!lastEndB) lastEndB=endT;
      if(lastEndB===nowSec){ ringBell(chosen.type); lastEndB=null; }
    }

    return;
  }

  // SHOW CLOCK + UPCOMING FOR BOTH
  timerDisplay.textContent = fmtClock(now);
  document.body.className = "state-none";

  const nA = stA.next;
  const nB = stB.next;

  const tA = nA ? `${nA.type==="lunch"?"Lunch":"Break"} at ${nA.startLabel}` : "â€”";
  const tB = nB ? `${nB.type==="lunch"?"Lunch":"Break"} at ${nB.startLabel}` : "â€”";

  combinedText.textContent = 
    `6A next: ${tA}  â€¢  6B next: ${tB}`;

  barA.style.width = barFill(nA, nowSec);
  barB.style.width = barFill(nB, nowSec);
}


// --------------------------------------------------
// HOOKS
// --------------------------------------------------
debugToggle.onclick = () => debugPanel.classList.toggle("visible");
document.getElementById("downloadJson").onclick = ()=>{
  const blob = new Blob([debugJson.value],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="schedule.json"; a.click();
  URL.revokeObjectURL(url);
};
document.getElementById("refreshButton").onclick = loadSchedules;
yearSelect.onchange = loadSchedules;


// --------------------------------------------------
// INIT
// --------------------------------------------------
(async()=>{
  await loadSchedules();
  updateDisplay();
  setInterval(updateDisplay,1000);
})();
</script>

</body>
</html>
