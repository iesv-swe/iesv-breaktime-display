<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Break Countdown â€“ IESV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-normal: linear-gradient(135deg, #071729, #0d2742);
      --bg-upcoming: linear-gradient(135deg, #004d40, #00796b);
      --bg-inbreak: linear-gradient(135deg, #1b5e20, #43a047);
      --bg-no-more: linear-gradient(135deg, #311b92, #512da8);

      --text-main: #ffffff;
      --text-muted: #cfd8dc;
    }

    body {
      font-family: system-ui, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-normal);
      color: var(--text-main);
      transition: background 0.5s ease;
      overflow: hidden;
    }

    body.state-upcoming { background: var(--bg-upcoming); }
    body.state-inbreak { background: var(--bg-inbreak); }
    body.state-none { background: var(--bg-no-more); }
    body.state-warning { animation: flash-bg 1s ease-in-out infinite alternate; }

    @keyframes flash-bg {
      0% { filter: brightness(1); }
      100% { filter: brightness(1.3); }
    }

    /* ------------------ TOP CONTROLS ------------------ */
    .top-controls {
      width: 100%;
      max-width: 900px;
      padding: 10px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }

    select, button {
      background: rgba(0,0,0,0.5);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button:hover { background: rgba(255,255,255,0.15); }

    /* Small bell icon button */
    .icon-btn {
      font-size: 1.2rem;
      padding: 4px 8px;
      line-height: 1;
    }

    /* ------------------ FULLSCREEN TIMER / CLOCK ------------------ */
    .timer-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      text-align: center;
      padding: 10px;
    }

    #timerDisplay {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      font-size: 18vw; /* HUGE fullscreen timer/clock */
      letter-spacing: 0.05em;
      text-shadow: 0 0 25px rgba(0,0,0,0.6);
      line-height: 1;
    }

    /* ------------------ BOTTOM INFO ------------------ */
    .bottom-info {
      width: 100%;
      text-align: center;
      padding-bottom: 10px;
    }

    #statusText { font-size: 1.3rem; font-weight: 600; }

    #statusDetail, #timerLabel {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ------------------ DEBUG PANEL ------------------ */
    #debugPanel {
      display: none;
      width: 95%;
      max-width: 900px;
      margin: 10px auto;
    }

    #debugPanel.visible { display: block; }

    textarea {
      width: 100%;
      height: 180px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.3);
      color: #e0f7fa;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.85rem;
      font-family: monospace;
    }
  </style>
</head>

<body>

  <!-- ðŸ”” SCHOOL BELL AUDIO -->
  <audio id="schoolBell" src="school_bell.mp3" preload="auto"></audio>

  <!-- ------------------ TOP MENU ------------------ -->
  <div class="top-controls">
    <select id="yearSelect">
      <option value="6" selected>Year 6 (6A + 6B)</option>
      <option value="6A">6A only</option>
      <option value="6B">6B only</option>
    </select>

    <button id="refreshButton">Reload</button>
    <button id="debugToggle">Debug</button>
    <button id="testBellButton" class="icon-btn">ðŸ””</button>
  </div>

  <!-- ------------------ FULLSCREEN TIMER / CLOCK ------------------ -->
  <div class="timer-container">
    <div id="timerDisplay">--:--</div>
  </div>

  <!-- ------------------ BOTTOM INFO ------------------ -->
  <div class="bottom-info">
    <div id="statusText">Loadingâ€¦</div>
    <div id="statusDetail"></div>
    <div id="timerLabel"></div>
  </div>

  <!-- ------------------ DEBUG PANEL ------------------ -->
  <div id="debugPanel">
    <textarea id="scheduleJson" readonly></textarea>
    <button id="downloadJsonButton">Download JSON</button>
  </div>

  <script src="parser.js"></script>
  <script>
    const yearSelect = document.getElementById("yearSelect");
    const refreshButton = document.getElementById("refreshButton");
    const debugToggle = document.getElementById("debugToggle");
    const debugPanel = document.getElementById("debugPanel");
    const scheduleJsonText = document.getElementById("scheduleJson");
    const downloadJsonButton = document.getElementById("downloadJsonButton");
    const testBellButton = document.getElementById("testBellButton");

    const statusText = document.getElementById("statusText");
    const statusDetail = document.getElementById("statusDetail");
    const timerDisplay = document.getElementById("timerDisplay");
    const timerLabel = document.getElementById("timerLabel");

    const schoolBell = document.getElementById("schoolBell");

    let currentSchedule = null;
    let lastBreakEnd = null;

    function getTodayAbbrev() {
      return ["Sun","Mon","Tue","Wed","Thur","Fri","Sat"][new Date().getDay()];
    }

    async function loadSchedule() {
      const yearKey = yearSelect.value;
      statusText.textContent = "Loading scheduleâ€¦";
      currentSchedule = await getScheduleForYear(yearKey);
      scheduleJsonText.value = JSON.stringify(currentSchedule, null, 2);
      statusText.textContent = "Schedule loaded";
    }

    /* ------------------ FORMATTERS ------------------ */
    function formatClockHHMM(date) {
      return (
        String(date.getHours()).padStart(2,"0") + ":" +
        String(date.getMinutes()).padStart(2,"0")
      );
    }

    function formatCountdown(seconds) {
      if (seconds < 0) seconds = 0;
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    /* ------------------ BELL ------------------ */
    function ringBell() {
      schoolBell.currentTime = 0;
      schoolBell.play();
      setTimeout(() => schoolBell.pause(), 5000);
    }

    testBellButton.addEventListener("click", ringBell);

    /* ------------------ MAIN LOGIC ------------------ */
    function updateCountdown() {
      const now = new Date();
      const nowSeconds = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
      const nowClock = formatClockHHMM(now);

      const day = getTodayAbbrev();
      const breaks = currentSchedule?.breaksByDay?.[day] || [];

      const schoolOpen = 7*3600;
      const schoolClose = 17.5*3600;

      /* BEFORE SCHOOL */
      if (nowSeconds < schoolOpen) {
        timerDisplay.textContent = nowClock;
        statusText.textContent = "School has not opened yet";
        statusDetail.textContent = "Opens at 07:00";
        timerLabel.textContent = "";
        document.body.className = "state-none";
        return;
      }

      /* AFTER SCHOOL */
      if (nowSeconds > schoolClose) {
        timerDisplay.textContent = nowClock;
        statusText.textContent = "School day finished";
        statusDetail.textContent = "Closes at 17:30";
        timerLabel.textContent = "";
        document.body.className = "state-none";
        return;
      }

      /* FIND BREAKS */
      let currentBreak = null;
      let nextBreak = null;

      for (const b of breaks) {
        const start = b.startMinutes*60;
        const end = b.endMinutes*60;

        if (nowSeconds >= start && nowSeconds < end) {
          currentBreak = { ...b, startSec: start, endSec: end };
          break;
        }
        if (nowSeconds < start && !nextBreak) {
          nextBreak = { ...b, startSec: start, endSec: end };
        }
      }

      /* BREAK END DETECTION */
      if (currentBreak) {
        lastBreakEnd = currentBreak.endSec;
      } else if (lastBreakEnd !== null && nowSeconds === lastBreakEnd) {
        ringBell();
        lastBreakEnd = null;
      }

      /* DURING BREAK */
      if (currentBreak) {
        const left = currentBreak.endSec - nowSeconds;
        timerDisplay.textContent = formatCountdown(left);
        timerLabel.textContent = "Time left in break";
        statusText.textContent = "IN BREAK";
        statusDetail.textContent = `Ends ${currentBreak.endLabel}`;
        document.body.className = left <= 60 ? "state-inbreak state-warning" : "state-inbreak";
        return;
      }

      /* COUNTDOWN TO NEXT BREAK */
      if (nextBreak) {
        const until = nextBreak.startSec - nowSeconds;

        /* If more than 90 minutes away â†’ show clock instead */
        if (until > 90*60) {
          timerDisplay.textContent = nowClock;
          statusText.textContent = "Next break is later today";
          statusDetail.textContent = `Starts ${nextBreak.startLabel}`;
          timerLabel.textContent = "";
          document.body.className = "state-none";
          return;
        }

        /* Show countdown */
        timerDisplay.textContent = formatCountdown(until);
        timerLabel.textContent = "Time until next break";
        statusText.textContent = "Next break coming up";
        statusDetail.textContent = `Starts ${nextBreak.startLabel}`;
        document.body.className = until <= 60 ? "state-upcoming state-warning" : "state-upcoming";
        return;
      }

      /* NO MORE BREAKS TODAY */
      timerDisplay.textContent = nowClock;
      statusText.textContent = "No more breaks today";
      timerLabel.textContent = "";
      document.body.className = "state-none";
    }

    /* ------------------ UI EVENTS ------------------ */
    debugToggle.addEventListener("click", () => {
      debugPanel.classList.toggle("visible");
    });

    downloadJsonButton.addEventListener("click", () => {
      const blob = new Blob([scheduleJsonText.value], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "schedule.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    yearSelect.addEventListener("change", loadSchedule);
    refreshButton.addEventListener("click", loadSchedule);

    /* ------------------ INIT ------------------ */
    (async () => {
      await loadSchedule();
      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();
  </script>

</body>
</html>
